# 深圳A股日线数据异步下载项目实现计划

## 项目概述

本项目旨在使用Baostock API自动下载深圳A股的日线数据，采用异步编程方式提高下载效率，并将每只股票的数据以股票代号保存到独立的JSON文件中。在测试阶段，每只股票最多下载一周的数据。

## 项目目标

- ✅ **数据获取**：通过Baostock API获取深圳A股的日线数据
- ✅ **异步处理**：使用Python异步编程提高数据下载效率
- ✅ **数据存储**：将每只股票数据保存为独立的JSON文件，文件名为股票代码
- ✅ **测试限制**：测试阶段每只股票最多下载一周数据

## 技术栈

### 核心技术
- **编程语言**：Python 3.11.2
- **数据源**：Baostock API（免费证券数据接口）
- **异步框架**：asyncio + aiofiles

### 主要依赖库
```
baostock>=0.8.8        # 证券数据获取
aiofiles>=23.2.0       # 异步文件操作
pandas>=2.0.0          # 数据处理和分析
asyncio                # 异步编程（内置）
json                   # JSON数据处理（内置）
datetime               # 日期时间处理（内置）
```

## 项目架构设计

### 目录结构
```
gpt-codex/
├── main.py                 # 主程序入口
├── src/
│   ├── __init__.py
│   ├── stock_fetcher.py    # 股票数据获取模块
│   ├── data_processor.py   # 数据处理模块
│   └── config.py           # 配置文件
├── data/                   # 数据存储目录
│   └── stocks/             # 股票JSON文件存储
├── logs/                   # 日志文件目录
├── requirements.txt        # 依赖包列表
├── README.md              # 项目说明文档
└── .gitignore             # Git忽略文件
```

### 核心模块设计

#### 1. 配置模块 (config.py)
```python
# 配置参数
MARKET_CODE = "sz"          # 深圳市场代码
TEST_DAYS = 7               # 测试阶段下载天数
MAX_CONCURRENT = 10         # 最大并发数
DATA_DIR = "data/stocks"    # 数据存储目录
LOG_DIR = "logs"            # 日志目录
```

#### 2. 股票数据获取模块 (stock_fetcher.py)
- **StockListFetcher**: 获取深圳A股股票列表
- **StockDataFetcher**: 异步获取单只股票数据
- **AsyncDownloadManager**: 管理异步下载任务

#### 3. 数据处理模块 (data_processor.py)
- **DataProcessor**: 数据清洗和格式化
- **JSONExporter**: 导出JSON文件
- **DataValidator**: 数据验证

## 详细实现步骤

### 第一阶段：环境准备和基础设置

#### 1.1 环境初始化
```bash
# 激活虚拟环境
source venv/bin/activate

# 安装依赖包
pip install baostock aiofiles pandas

# 创建项目目录结构
mkdir -p src data/stocks logs
```

#### 1.2 创建配置文件
- 定义项目配置参数
- 设置日志配置
- 配置数据存储路径

### 第二阶段：股票列表获取

#### 2.1 Baostock连接管理
```python
import baostock as bs

class BaostockManager:
    def __enter__(self):
        lg = bs.login()
        if lg.error_code != '0':
            raise Exception(f"登录失败: {lg.error_msg}")
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        bs.logout()
```

#### 2.2 深圳A股列表获取
```python
async def get_shenzhen_stocks():
    """获取深圳A股股票列表"""
    with BaostockManager():
        rs = bs.query_all_stock()
        stocks = []
        while rs.next():
            stock_info = rs.get_row_data()
            if stock_info[0].startswith('sz.'):
                stocks.append({
                    'code': stock_info[0],
                    'name': stock_info[1],
                    'type': stock_info[2]
                })
    return stocks
```

### 第三阶段：异步数据下载

#### 3.1 单只股票数据获取
```python
import asyncio
import aiofiles
from datetime import datetime, timedelta

async def fetch_single_stock_data(stock_code, semaphore):
    """异步获取单只股票数据"""
    async with semaphore:  # 控制并发数
        try:
            # 计算日期范围（测试阶段：一周数据）
            end_date = datetime.now().strftime('%Y-%m-%d')
            start_date = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
            
            # 使用Baostock API获取数据
            with BaostockManager():
                rs = bs.query_history_k_data_plus(
                    stock_code,
                    "date,code,open,high,low,close,volume,amount",
                    start_date=start_date,
                    end_date=end_date,
                    frequency="d"
                )
                
                # 处理数据
                data_list = []
                while rs.next():
                    data_list.append(rs.get_row_data())
                
                # 保存为JSON文件
                await save_stock_data(stock_code, data_list)
                
        except Exception as e:
            print(f"获取股票 {stock_code} 数据失败: {e}")
```

#### 3.2 异步任务管理
```python
async def download_all_stocks(stock_list, max_concurrent=10):
    """异步下载所有股票数据"""
    semaphore = asyncio.Semaphore(max_concurrent)
    
    tasks = [
        fetch_single_stock_data(stock['code'], semaphore)
        for stock in stock_list
    ]
    
    # 执行所有任务
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    # 统计结果
    success_count = sum(1 for r in results if not isinstance(r, Exception))
    print(f"成功下载 {success_count}/{len(tasks)} 只股票数据")
```

### 第四阶段：数据处理和存储

#### 4.1 数据格式化
```python
import pandas as pd
import json

async def save_stock_data(stock_code, raw_data):
    """保存股票数据为JSON文件"""
    try:
        # 转换为DataFrame进行处理
        df = pd.DataFrame(raw_data, columns=[
            'date', 'code', 'open', 'high', 'low', 'close', 'volume', 'amount'
        ])
        
        # 数据类型转换
        numeric_columns = ['open', 'high', 'low', 'close', 'volume', 'amount']
        for col in numeric_columns:
            df[col] = pd.to_numeric(df[col], errors='coerce')
        
        # 转换为字典格式
        data_dict = {
            'stock_code': stock_code,
            'download_time': datetime.now().isoformat(),
            'data_count': len(df),
            'data': df.to_dict('records')
        }
        
        # 异步保存文件
        filename = f"data/stocks/{stock_code.replace('.', '_')}.json"
        async with aiofiles.open(filename, 'w', encoding='utf-8') as f:
            await f.write(json.dumps(data_dict, ensure_ascii=False, indent=2))
            
    except Exception as e:
        print(f"保存股票 {stock_code} 数据失败: {e}")
```

### 第五阶段：主程序集成

#### 5.1 主程序流程
```python
async def main():
    """主程序入口"""
    print("开始下载深圳A股日线数据...")
    
    # 1. 获取股票列表
    print("正在获取深圳A股股票列表...")
    stock_list = await get_shenzhen_stocks()
    print(f"共找到 {len(stock_list)} 只深圳A股")
    
    # 2. 创建数据目录
    os.makedirs("data/stocks", exist_ok=True)
    
    # 3. 异步下载数据
    print("开始异步下载股票数据...")
    start_time = time.time()
    await download_all_stocks(stock_list, max_concurrent=10)
    end_time = time.time()
    
    print(f"下载完成，耗时: {end_time - start_time:.2f} 秒")

if __name__ == "__main__":
    asyncio.run(main())
```

## 性能优化策略

### 1. 并发控制
- 使用`asyncio.Semaphore`控制最大并发数（建议10-20）
- 避免过度并发导致API限制或系统资源耗尽

### 2. 错误处理
- 实现重试机制，对失败的请求进行重试
- 记录详细的错误日志，便于问题排查
- 优雅处理网络异常和API异常

### 3. 内存管理
- 使用流式处理，避免一次性加载大量数据
- 及时释放不需要的数据对象

### 4. 数据验证
- 验证下载数据的完整性和正确性
- 检查数据格式和数值范围

## 测试策略

### 1. 单元测试
- 测试股票列表获取功能
- 测试单只股票数据下载功能
- 测试数据保存功能

### 2. 集成测试
- 测试完整的下载流程
- 测试异常情况处理
- 测试并发性能

### 3. 数据验证测试
- 验证下载数据的准确性
- 检查JSON文件格式
- 对比不同时间段的数据一致性

## 风险评估和应对

### 1. API限制风险
- **风险**：Baostock可能有访问频率限制
- **应对**：实现请求间隔控制，添加重试机制

### 2. 网络异常风险
- **风险**：网络不稳定导致下载失败
- **应对**：实现断点续传，记录下载进度

### 3. 数据质量风险
- **风险**：获取的数据可能不完整或有误
- **应对**：实现数据验证和清洗机制

### 4. 存储空间风险
- **风险**：大量JSON文件占用存储空间
- **应对**：定期清理旧数据，实现数据压缩

## 后续扩展计划

### 1. 功能扩展
- 支持上海A股数据下载
- 支持不同时间周期数据（周线、月线）
- 添加数据可视化功能

### 2. 性能优化
- 实现数据库存储
- 添加数据缓存机制
- 优化异步下载算法

### 3. 监控和运维
- 添加下载进度监控
- 实现邮件/短信通知功能
- 添加定时任务调度

## 项目时间安排

| 阶段 | 任务 | 预计时间 | 负责人 |
|------|------|----------|--------|
| 第一阶段 | 环境准备和基础设置 | 0.5天 | 开发者 |
| 第二阶段 | 股票列表获取功能 | 1天 | 开发者 |
| 第三阶段 | 异步数据下载功能 | 2天 | 开发者 |
| 第四阶段 | 数据处理和存储 | 1天 | 开发者 |
| 第五阶段 | 主程序集成和测试 | 1天 | 开发者 |
| **总计** | **完整项目实现** | **5.5天** | **开发者** |

## 成功标准

### 1. 功能标准
- ✅ 能够成功获取深圳A股股票列表
- ✅ 能够异步下载股票日线数据
- ✅ 数据能够正确保存为JSON格式
- ✅ 测试阶段每只股票下载一周数据

### 2. 性能标准
- ✅ 下载速度比同步方式提升50%以上
- ✅ 并发处理能力达到10-20只股票同时下载
- ✅ 内存使用控制在合理范围内

### 3. 质量标准
- ✅ 代码覆盖率达到80%以上
- ✅ 异常处理覆盖主要错误场景
- ✅ 数据准确性验证通过

---

*本文档将随着项目进展持续更新和完善。*
